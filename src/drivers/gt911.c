#include <stdint.h>
#include "drivers/gt911.h"
#include <fcntl.h>
#include <unistd.h>
#include <sys/ioctl.h>
#include <linux/i2c-dev.h>
#include <bcm2835.h>
#include "project_settings.h"
#include "drivers/gpio.h"

#define GT911_ADDR 0x5D
#define I2C_BUS "/dev/i2c-1"
#define GT911_RCONFIG_REG 0x8047

// https://www.orientdisplay.com/pdf/GT911.pdf
static uint8_t GT911_Config[] = {\
    0x00,0xE0,0x01,0x20,0x03,0x0A,0x05,0x00,0x01,0x0F, // 0x8047 .. 0x050
    0x28,0x0F,0x50,0x32,0x03,0x05,0x00,0x00,0x00,0x00, // 0x8051 .. 0x805A
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x89,0x29,0x0A, // 0x8-5B .. 0x054
    0x52,0x50,0x0C,0x08,0x00,0x00,0x00,0x00,0x03,0x1D,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x32,0x00,0x00,
    0x00,0x48,0x70,0x94,0xC5,0x02,0x07,0x00,0x00,0x04,
    0x87,0x4B,0x00,0x7D,0x52,0x00,0x74,0x59,0x00,0x6B,
    0x62,0x00,0x64,0x6B,0x00,0x64,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x08,0x0A,0x0C,0x0E,0x10,0x12,0x14,0x16,
    0x18,0x1A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x2A,0x29,0x28,0x24,0x22,0x20,0x1F,0x1E,
    0x1D,0x0E,0x0C,0x0A,0x08,0x06,0x05,0x04,0x02,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0xAA,0x01
};

/* Private function prototypes */
static void _GT911_Init_GPIO(void);

/* Function definitions */
GT911_Status_t GT911_Reset(void)
{
    GPIO_SetDirIn(TP_INT_PIN, true);
    GPIO_SetLevel(TP_RST_PIN, LOW);
    delay(20);
    GPIO_SetLevel(TP_INT_PIN, LOW);
    delay(20);
    GPIO_SetLevel(TP_RST_PIN, HIGH);
    delay(100);
    GPIO_SetDirOut(TP_INT_PIN);
    delay(100);
    return GT911_OK;
}

GT911_Status_t GT911_Init(void)
{
    // Open I2C Bus
    int fd = open(I2C_BUS, O_RDWR);
    if(fd < 0)
    {
        return GT911_ERR;
    }

    // Access GT911
    if(ioctl(fd, I2C_SLAVE, GT911_ADDR) < 0)
    {
        return GT911_ERR;
    }



    return GT911_OK;
}

void _GT911_Init_GPIO(void)
{
    GPIO_SetDirIn(TP_INT_PIN, true);
}